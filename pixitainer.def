Bootstrap: docker
From: ubuntu:24.04

%files
    {{ FILES_SECTION }}

%environment
    # Set the path to the global Pixi installation
    export PIXI_HOME=/opt/pixi
    export PATH="/opt/pixi/bin:$PATH"

%post
    export DEBIAN_FRONTEND=noninteractive

    # 1. Install system dependencies
    apt-get update && apt-get install -y curl

    # 2. Install Pixi globally to /opt/pixi (instead of /root)
    export PIXI_HOME=/opt/pixi
    curl -fsSL https://pixi.sh/install.sh | bash
    export PATH="/opt/pixi/bin:$PATH"

    # 3. Setup the Project Environment
    mkdir -p /app
    cd /app

    echo "Installing project environment..."
    # We use --frozen to ensure it perfectly matches the lockfile
    pixi install --frozen

    # 4. Cleanup to reduce image size
    apt-get remove -y curl
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    # cd /app
    {{ RUNSCRIPT_CONTENT }}