#!/bin/bash
set -e

# --- Valeurs par d√©faut ---
OUTPUT="pixitainer.sif"
PROJECT_PATH="."
SEAMLESS=false
BASE_IMAGE="ubuntu:24.04"
TARGET_PIXI_VERSION=""
KEEP_DEF=false
VERBOSE=false
declare -a ENVS

# --- Fonction d'aide ---
usage() {
    echo "Usage: $0 [options]"
    echo ""
    echo "Pixi extension to containerize a project with Apptainer"
    echo ""
    echo "Options:"
    echo "  -o, --output OUTPUT       Output image path (default: pixitainer.sif)"
    echo "  -p, --path PATH           Working directory (source project)"
    echo "  -s, --seamless            Enable seamless execution"
    echo "  -e, --env ENV             Specific environment(s) to install (can be used multiple times)"
    echo "  --base-image IMAGE        Specify base image (default: ubuntu:24.04)"
    echo "  --pixi-version VERSION    Specify pixi version (default: latest)"
    echo "  --keep-def                Export the .def file (do not delete temporary files)"
    echo "  --verbose                 Verbose mode (show full Apptainer build output)"
    echo "  -h, --help                Show this help message"
}

# --- Parsing des arguments ---
while [[ $# -gt 0 ]]; do
    case $1 in
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        -p|--path)
            PROJECT_PATH="$2"
            shift 2
            ;;
        -s|--seamless)
            SEAMLESS=true
            shift
            ;;
        -e|--env)
            ENVS+=("$2")
            shift 2
            ;;
        --base-image)
            BASE_IMAGE="$2"
            shift 2
            ;;
        --pixi-version)
            TARGET_PIXI_VERSION="$2"
            shift 2
            ;;
        --keep-def)
            KEEP_DEF=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Error: Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# --- R√©solution des chemins ---
# On utilise cd + pwd pour obtenir le chemin absolu compatible Linux/macOS
WD=$(cd "$PROJECT_PATH" && pwd)
# Pour l'output, on g√®re le cas o√π le fichier n'existe pas encore
OUTPUT_DIR=$(dirname "$OUTPUT")
# Si output est relatif, on le rend absolu par rapport au dossier courant
if [[ "$OUTPUT_DIR" == "." ]]; then
    OUTPUT_ABS="$(pwd)/$OUTPUT"
    OUTPUT_PARENT="$(pwd)"
else
    mkdir -p "$OUTPUT_DIR"
    OUTPUT_ABS="$(cd "$OUTPUT_DIR" && pwd)/$(basename "$OUTPUT")"
    OUTPUT_PARENT="$(cd "$OUTPUT_DIR" && pwd)"
fi

TMP_DIR="$OUTPUT_PARENT/.tmp_pixitainer"
PIXI_TOML="$WD/pixi.toml"
PIXI_LOCK="$WD/pixi.lock"

# --- V√©rifications ---
if [ ! -f "$PIXI_TOML" ]; then
    echo "Error: pixi.toml not found in $WD"
    exit 1
fi

echo "üì¶ Containerizing project from: $WD"
echo "üìÇ Output target: $OUTPUT_ABS"

# --- Pr√©paration du .def ---
mkdir -p "$TMP_DIR"
TARGET_DEF="$TMP_DIR/pixitainer.def"

# Construction de la section %files
FILES_SECTION="    \"$PIXI_TOML\" /opt/conf/pixi.toml"
if [ -f "$PIXI_LOCK" ]; then
    FILES_SECTION="$FILES_SECTION"$'\n'"    \"$PIXI_LOCK\" /opt/conf/pixi.lock"
fi

# Construction de la commande d'installation
if [ ${#ENVS[@]} -gt 0 ]; then
    ENV_FLAGS=""
    for env in "${ENVS[@]}"; do
        ENV_FLAGS="$ENV_FLAGS -e $env"
    done
    INSTALL_CMD="pixi install $ENV_FLAGS --frozen"
else
    INSTALL_CMD="pixi install -a --frozen"
fi

# Logique Seamless
if [ "$SEAMLESS" = true ]; then
    RUNSCRIPT_CONTENT='pixi run --as-is -m /opt/conf/pixi.toml "$@"'
else
    RUNSCRIPT_CONTENT='exec "$@"'
fi

# Gestion de la version de Pixi
PIXI_VERSION_ENV=""
if [ -n "$TARGET_PIXI_VERSION" ]; then
    PIXI_VERSION_ENV="pixi self-update --version $TARGET_PIXI_VERSION"
fi

# √âcriture du fichier de d√©finition (Here-Doc)
cat <<EOF > "$TARGET_DEF"
Bootstrap: docker
From: $BASE_IMAGE

%files
$FILES_SECTION

%environment
    export PIXI_HOME=/opt/pixi
    export PIXI_PROJECT_MANIFEST=/opt/conf/pixi.toml
    export PATH="/opt/pixi/bin:\$PATH"

%post
    export DEBIAN_FRONTEND=noninteractive

    # 1. Install system dependencies
    apt-get update && apt-get install -y curl

    # 2. Install Pixi globally to /opt/pixi
    export PIXI_HOME=/opt/pixi
    curl -fsSL https://pixi.sh/install.sh | bash
    export PATH="/opt/pixi/bin:\$PATH"

    $PIXI_VERSION_ENV

    # 3. Setup the Project Environment
    mkdir -p /opt/conf
    cd /opt/conf

    echo "Installing project environment..."
    pixi config set --local run-post-link-scripts insecure
    $INSTALL_CMD

    # 4. Cleanup
    apt-get remove -y curl
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    $RUNSCRIPT_CONTENT
EOF

# --- Build Apptainer ---
OS_NAME=$(uname -s)

if [ "$OS_NAME" == "Linux" ]; then
    echo "üöÄ Starting Apptainer build..."

    CMD=(apptainer build --force --fakeroot "$OUTPUT_ABS" "$TARGET_DEF")

    if [ "$VERBOSE" = true ]; then
        "${CMD[@]}"
    else
        # Capture de sortie standard et erreur si non verbose
        OUTPUT_LOG=$("${CMD[@]}" 2>&1) || {
            EC=$?
            echo "‚ùå Final build failed."
            echo ""
            echo "--- STDERR ---"
            echo "$OUTPUT_LOG"
            exit $EC
        }
    fi

    echo "‚úÖ Success! Image built at: $OUTPUT_ABS"

    # Cleanup
    if [ "$KEEP_DEF" = true ]; then
        echo "‚ÑπÔ∏è  Definition file kept at: $TARGET_DEF"
    else
        if [ -d "$TMP_DIR" ]; then
            rm -rf "$TMP_DIR"
        fi
    fi

else
    # Cas macOS / Windows
    echo "‚úÖ Definition file created at: $TARGET_DEF"
    echo "‚ö†Ô∏è  You are on $OS_NAME. Apptainer builds require Linux."
    echo "‚ÑπÔ∏è  To build the image, copy this folder to a Linux machine and run:"
    echo "   apptainer build $(basename "$OUTPUT_ABS") $(basename "$TARGET_DEF")"

    if [ "$KEEP_DEF" != true ]; then
        echo "‚ÑπÔ∏è  Note: Use --keep-def on Linux to preserve this file automatically."
    fi
fi